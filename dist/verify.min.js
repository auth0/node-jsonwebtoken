var JsonWebTokenError=require("./lib/JsonWebTokenError"),NotBeforeError=require("./lib/NotBeforeError"),TokenExpiredError=require("./lib/TokenExpiredError"),decode=require("./decode"),timespan=require("./lib/timespan"),PS_SUPPORTED=require("./lib/psSupported"),jws=require("jws"),PUB_KEY_ALGS=["RS256","RS384","RS512","ES256","ES384","ES512"],RSA_KEY_ALGS=["RS256","RS384","RS512"],HS_ALGS=["HS256","HS384","HS512"];PS_SUPPORTED&&(PUB_KEY_ALGS.splice(3,0,"PS256","PS384","PS512"),RSA_KEY_ALGS.splice(3,0,"PS256","PS384","PS512")),module.exports=function(u,n,c,e){var d;if("function"!=typeof c||e||(e=c,c={}),c=c||{},c=Object.assign({},c),d=e||function(e,r){if(e)throw e;return r},c.clockTimestamp&&"number"!=typeof c.clockTimestamp)return d(new JsonWebTokenError("clockTimestamp must be a number"));if(void 0!==c.nonce&&("string"!=typeof c.nonce||""===c.nonce.trim()))return d(new JsonWebTokenError("nonce must be a non-empty string"));var f=c.clockTimestamp||Math.floor(Date.now()/1e3);if(!u)return d(new JsonWebTokenError("jwt must be provided"));if("string"!=typeof u)return d(new JsonWebTokenError("jwt must be a string"));var l,b=u.split(".");if(3!==b.length)return d(new JsonWebTokenError("jwt malformed"));try{l=decode(u,{complete:!0})}catch(e){return d(e)}if(!l)return d(new JsonWebTokenError("invalid token"));var r,p=l.header;if("function"==typeof n){if(!e)return d(new JsonWebTokenError("verify must be called asynchronous if secret or public key is provided as a callback"));r=n}else r=function(e,r){return r(null,n)};return r(p,function(e,r){if(e)return d(new JsonWebTokenError("error in secret or public key callback: "+e.message));var n,o=""!==b[2].trim();if(!o&&r)return d(new JsonWebTokenError("jwt signature is required"));if(o&&!r)return d(new JsonWebTokenError("secret or public key must be provided"));if(o||c.algorithms||(c.algorithms=["none"]),c.algorithms||(c.algorithms=~r.toString().indexOf("BEGIN CERTIFICATE")||~r.toString().indexOf("BEGIN PUBLIC KEY")?PUB_KEY_ALGS:~r.toString().indexOf("BEGIN RSA PUBLIC KEY")?RSA_KEY_ALGS:HS_ALGS),!~c.algorithms.indexOf(l.header.alg))return d(new JsonWebTokenError("invalid algorithm"));try{n=jws.verify(u,l.header.alg,r)}catch(e){return d(e)}if(!n)return d(new JsonWebTokenError("invalid signature"));var i=l.payload;if(void 0!==i.nbf&&!c.ignoreNotBefore){if("number"!=typeof i.nbf)return d(new JsonWebTokenError("invalid nbf value"));if(i.nbf>f+(c.clockTolerance||0))return d(new NotBeforeError("jwt not active",new Date(1e3*i.nbf)))}if(void 0!==i.exp&&!c.ignoreExpiration){if("number"!=typeof i.exp)return d(new JsonWebTokenError("invalid exp value"));if(f>=i.exp+(c.clockTolerance||0))return d(new TokenExpiredError("jwt expired",new Date(1e3*i.exp)))}if(c.audience){var t=Array.isArray(c.audience)?c.audience:[c.audience];if(!(Array.isArray(i.aud)?i.aud:[i.aud]).some(function(r){return t.some(function(e){return e instanceof RegExp?e.test(r):e===r})}))return d(new JsonWebTokenError("jwt audience invalid. expected: "+t.join(" or ")))}if(c.issuer&&("string"==typeof c.issuer&&i.iss!==c.issuer||Array.isArray(c.issuer)&&-1===c.issuer.indexOf(i.iss)))return d(new JsonWebTokenError("jwt issuer invalid. expected: "+c.issuer));if(c.subject&&i.sub!==c.subject)return d(new JsonWebTokenError("jwt subject invalid. expected: "+c.subject));if(c.jwtid&&i.jti!==c.jwtid)return d(new JsonWebTokenError("jwt jwtid invalid. expected: "+c.jwtid));if(c.nonce&&i.nonce!==c.nonce)return d(new JsonWebTokenError("jwt nonce invalid. expected: "+c.nonce));if(c.maxAge){if("number"!=typeof i.iat)return d(new JsonWebTokenError("iat required when maxAge is specified"));var s=timespan(c.maxAge,i.iat);if(void 0===s)return d(new JsonWebTokenError('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(f>=s+(c.clockTolerance||0))return d(new TokenExpiredError("maxAge exceeded",new Date(1e3*s)))}if(!0!==c.complete)return d(null,i);var a=l.signature;return d(null,{header:p,payload:i,signature:a})})};